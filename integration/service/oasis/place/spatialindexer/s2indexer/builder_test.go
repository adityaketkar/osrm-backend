package s2indexer

import (
	"reflect"
	"sort"
	"testing"

	"github.com/Telenav/osrm-backend/integration/api/nav"
	"github.com/Telenav/osrm-backend/integration/service/oasis/internal/entity"
	"github.com/golang/geo/s2"
	"github.com/golang/glog"
)

// online tool for google s2: http://s2.sidewalklabs.com/regioncoverer/
func TestBuild(t *testing.T) {
	cases := []struct {
		places []entity.PlaceWithLocation
		expect map[s2.CellID][]entity.PlaceID
	}{
		{
			[]entity.PlaceWithLocation{
				{
					ID: 1,
					Location: &nav.Location{
						Lat: 37.402701,
						Lon: -121.974096,
					},
				},
			},
			map[s2.CellID][]entity.PlaceID{
				9263622958524399616: {1}, // 4/001013
				9263834064756932608: {1}, // 4/0010133
				9263851656942977024: {1}, // 4/00101332
				9263847258896465920: {1}, // 4/001013321
				9263843960361582592: {1}, // 4/0010133210
				9263844784995303424: {1}, // 4/00101332103
				9263844853714780160: {1}, // 4/001013321032
				9263844836534910976: {1}, // 4/0010133210321
				9263844823650009088: {1}, // 4/00101332103210
				9263844822576267264: {1}, // 4/001013321032101
				9263844823381573632: {1}, // 4/0010133210321013
				9263844823180247040: {1}, // 4/00101332103210130
				9263844823129915392: {1}, // 4/001013321032101300
				9263844823134109696: {1}, // 4/0010133210321013002
				9263844823130963968: {1}, // 4/00101332103210130020
				9263844823130701824: {1}, // 4/001013321032101300201
				9263844823130898432: {1}, // 4/0010133210321013002013
				9263844823130947584: {1}, // 4/00101332103210130020133
				9263844823130943488: {1}, // 4/001013321032101300201331
				9263844823130944512: {1}, // 4/0010133210321013002013312
				9263844823130943744: {1}, // 4/00101332103210130020133120
				9263844823130943680: {1}, // 4/001013321032101300201331201
				9263844823130943696: {1}, // 4/0010133210321013002013312012
				9263844823130943708: {1}, // 4/00101332103210130020133120123
				9263844823130943709: {1}, // 4/001013321032101300201331201232
			},
		},

		// Test case of 2 places, both near to 4655 Great America Pkwy
		{
			[]entity.PlaceWithLocation{
				{
					ID: 1,
					Location: &nav.Location{
						Lat: 37.402701,
						Lon: -121.974096,
					},
				},
				{
					ID: 2,
					Location: &nav.Location{
						Lat: 37.403530,
						Lon: -121.969768,
					},
				},
			},
			map[s2.CellID][]entity.PlaceID{
				9263622958524399616: {1, 2}, // 4/001013
				9263834064756932608: {1, 2}, // 4/0010133
				9263851656942977024: {1, 2}, // 4/00101332
				9263847258896465920: {1, 2}, // 4/001013321
				9263843960361582592: {1, 2}, // 4/0010133210
				9263844784995303424: {1, 2}, // 4/00101332103
				9263844716275826688: {2},    // 4/001013321031
				9263844733455695872: {2},    // 4/0010133210312
				9263844746340597760: {2},    // 4/00101332103123
				9263844749561823232: {2},    // 4/001013321031233
				9263844749830258688: {2},    // 4/0010133210312332
				9263844750031585280: {2},    // 4/00101332103123323
				9263844749981253632: {2},    // 4/001013321031233230
				9263844749993836544: {2},    // 4/0010133210312332303
				9263844749996982272: {2},    // 4/00101332103123323033
				9263844749996720128: {2},    // 4/001013321031233230331
				9263844749996916736: {2},    // 4/0010133210312332303313
				9263844749996900352: {2},    // 4/00101332103123323033131
				9263844749996896256: {2},    // 4/001013321031233230331311
				9263844749996893184: {2},    // 4/0010133210312332303313110
				9263844749996892416: {2},    // 4/00101332103123323033131100
				9263844749996892608: {2},    // 4/001013321031233230331311003
				9263844749996892592: {2},    // 4/0010133210312332303313110031
				9263844749996892588: {2},    // 4/00101332103123323033131100311
				9263844749996892591: {2},    // 4/001013321031233230331311003113
				9263844853714780160: {1},    // 4/001013321032
				9263844836534910976: {1},    // 4/0010133210321
				9263844823650009088: {1},    // 4/00101332103210
				9263844822576267264: {1},    // 4/001013321032101
				9263844823381573632: {1},    // 4/0010133210321013
				9263844823180247040: {1},    // 4/00101332103210130
				9263844823129915392: {1},    // 4/001013321032101300
				9263844823134109696: {1},    // 4/0010133210321013002
				9263844823130963968: {1},    // 4/00101332103210130020
				9263844823130701824: {1},    // 4/001013321032101300201
				9263844823130898432: {1},    // 4/0010133210321013002013
				9263844823130947584: {1},    // 4/00101332103210130020133
				9263844823130943488: {1},    // 4/001013321032101300201331
				9263844823130944512: {1},    // 4/0010133210321013002013312
				9263844823130943744: {1},    // 4/00101332103210130020133120
				9263844823130943680: {1},    // 4/001013321032101300201331201
				9263844823130943696: {1},    // 4/0010133210321013002013312012
				9263844823130943708: {1},    // 4/00101332103210130020133120123
				9263844823130943709: {1},    // 4/001013321032101300201331201232
			},
		},

		// Test case of 4 places, which distrubted in CA, US
		// Each place have about 100km distance with each other
		{
			[]entity.PlaceWithLocation{
				{
					ID: 1,
					Location: &nav.Location{
						Lat: 37.651275,
						Lon: -122.413744,
					},
				},
				{
					ID: 2,
					Location: &nav.Location{
						Lat: 36.776215,
						Lon: -121.733663,
					},
				},
				{
					ID: 3,
					Location: &nav.Location{
						Lat: 36.122438,
						Lon: -121.022936,
					},
				},
				{
					ID: 4,
					Location: &nav.Location{
						Lat: 35.365543,
						Lon: -120.850000,
					},
				},
			},
			map[s2.CellID][]entity.PlaceID{
				9263622958524399616: {1, 2}, // 4/001013
				9263411852291866624: {2},    // 4/0010130
				9263359075733733376: {2},    // 4/00101300
				9263345881594200064: {2},    // 4/001013000
				9263349180129083392: {2},    // 4/0010130003
				9263349455006990336: {2},    // 4/00101300032
				9263349386287513600: {2},    // 4/001013000321
				9263349437827121152: {2},    // 4/0010130003213
				9263349433532153856: {2},    // 4/00101300032131
				9263349432458412032: {2},    // 4/001013000321311
				9263349432726847488: {2},    // 4/0010130003213112
				9263349432928174080: {2},    // 4/00101300032131123
				9263349432877842432: {2},    // 4/001013000321311230
				9263349432873648128: {2},    // 4/0010130003213112301
				9263349432874696704: {2},    // 4/00101300032131123012
				9263349432874434560: {2},    // 4/001013000321311230121
				9263349432874500096: {2},    // 4/0010130003213112301212
				9263349432874516480: {2},    // 4/00101300032131123012122
				9263349432874528768: {2},    // 4/001013000321311230121223
				9263349432874525696: {2},    // 4/0010130003213112301212230
				9263349432874526464: {2},    // 4/00101300032131123012122303
				9263349432874526528: {2},    // 4/001013000321311230121223032
				9263349432874526544: {2},    // 4/0010130003213112301212230322
				9263349432874526556: {2},    // 4/00101300032131123012122303223
				9263349432874526559: {2},    // 4/001013000321311230121223032233
				9263693327268577280: {1},    // 4/0010132
				9263746103826710528: {1},    // 4/00101323
				9263759297966243840: {1},    // 4/001013233
				9263755999431360512: {1},    // 4/0010132330
				9263756824065081344: {1},    // 4/00101323303
				9263756755345604608: {1},    // 4/001013233031
				9263756703805997056: {1},    // 4/0010132330310
				9263756708100964352: {1},    // 4/00101323303102
				9263756709174706176: {1},    // 4/001013233031022
				9263756709980012544: {1},    // 4/0010132330310223
				9263756709912903680: {1},    // 4/00101323303102231
				9263756709862572032: {1},    // 4/001013233031022310
				9263756709866766336: {1},    // 4/0010132330310223102
				9263756709867814912: {1},    // 4/00101323303102231022
				9263756709867028480: {1},    // 4/001013233031022310220
				9263756709866962944: {1},    // 4/0010132330310223102201
				9263756709866913792: {1},    // 4/00101323303102231022010
				9263756709866909696: {1},    // 4/001013233031022310220101
				9263756709866908672: {1},    // 4/0010132330310223102201011
				9263756709866907904: {1},    // 4/00101323303102231022010110
				9263756709866907840: {1},    // 4/001013233031022310220101101
				9263756709866907856: {1},    // 4/0010132330310223102201011012
				9263756709866907844: {1},    // 4/00101323303102231022010110120
				9263756709866907845: {1},    // 4/001013233031022310220101101202
				9264748858431242240: {3},    // 4/001021
				9264678489687064576: {3},    // 4/0010211
				9264731266245197824: {3},    // 4/00102113
				9264718072105664512: {3},    // 4/001021130
				9264719171617292288: {3},    // 4/0010211302
				9264718346983571456: {3},    // 4/00102113020
				9264718415703048192: {3},    // 4/001021130202
				9264718398523179008: {3},    // 4/0010211302021
				9264718411408080896: {3},    // 4/00102113020213
				9264718414629306368: {3},    // 4/001021130202133
				9264718413824000000: {3},    // 4/0010211302021330
				9264718414025326592: {3},    // 4/00102113020213303
				9264718414042103808: {3},    // 4/001021130202133032
				9264718414046298112: {3},    // 4/0010211302021330322
				9264718414043152384: {3},    // 4/00102113020213303220
				9264718414042365952: {3},    // 4/001021130202133032200
				9264718414042169344: {3},    // 4/0010211302021330322000
				9264718414042152960: {3},    // 4/00102113020213303220001
				9264718414042140672: {3},    // 4/001021130202133032200010
				9264718414042143744: {3},    // 4/0010211302021330322000103
				9264718414042143488: {3},    // 4/00102113020213303220001031
				9264718414042143296: {3},    // 4/001021130202133032200010310
				9264718414042143280: {3},    // 4/0010211302021330322000103101
				9264718414042143284: {3},    // 4/00102113020213303220001031012
				9264718414042143285: {3},    // 4/001021130202133032200010310122
				9290081606335201280: {4},    // 4/001312
				9290011237591023616: {4},    // 4/0013121
				9290064014149156864: {4},    // 4/00131213
				9290050820009623552: {4},    // 4/001312130
				9290047521474740224: {4},    // 4/0013121300
				9290048346108461056: {4},    // 4/00131213003
				9290048139950030848: {4},    // 4/001312130030
				9290048191489638400: {4},    // 4/0013121300303
				9290048195784605696: {4},    // 4/00131213003032
				9290048196858347520: {4},    // 4/001312130030322
				9290048197663653888: {4},    // 4/0013121300303223
				9290048197864980480: {4},    // 4/00131213003032233
				9290048197881757696: {4},    // 4/001312130030322332
				9290048197885952000: {4},    // 4/0013121300303223322
				9290048197882806272: {4},    // 4/00131213003032233220
				9290048197883068416: {4},    // 4/001312130030322332202
				9290048197883002880: {4},    // 4/0013121300303223322021
				9290048197883052032: {4},    // 4/00131213003032233220213
				9290048197883039744: {4},    // 4/001312130030322332202130
				9290048197883040768: {4},    // 4/0013121300303223322021302
				9290048197883041024: {4},    // 4/00131213003032233220213022
				9290048197883041216: {4},    // 4/001312130030322332202130223
				9290048197883041200: {4},    // 4/0013121300303223322021302231
				9290048197883041212: {4},    // 4/00131213003032233220213022313
				9290048197883041211: {4},    // 4/001312130030322332202130223131
			},
		},
	}

	for i, c := range cases {
		actual := build(c.places, 6, 30)

		// sort slice to directly use DeepEqual,  Build()'s result no need to guarantee the sequence
		for k := range actual {
			sort.Slice(actual[k], func(i, j int) bool {
				return actual[k][i] < actual[k][j]
			})
			glog.Infof("%d: %v,   // %v\n", (uint64)(k), actual[k], k)
		}

		if !reflect.DeepEqual(actual, c.expect) {
			t.Errorf("parse case %d \n%v, expect\n %v \n but got %v", i, c, c.expect, actual)
		}
	}
}
